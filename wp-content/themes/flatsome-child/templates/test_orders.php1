<?php
/*
Template name: Users orders lists Average
*/
get_header();

die('Access denied, contact admin');
global $wpdb;

$from_date = date('Y-01-01');
//$to_date = date('Y-m-d');
$to_date_original = $to_date = date('Y-m-d');
$to_date = date('Y-m-d', strtotime($to_date . ' +1 day'));
$from_date = date('Y-m-d', strtotime($to_date . ' -7 day'));
if (!empty($_POST)) {
    $from_date = $_POST['from_date'];
    $to_date = $_POST['to_date'];
    $from_date = date('Y-m-d', strtotime($from_date));
  //  $to_date = date('Y-m-d', strtotime($to_date));
     $to_date_original = $to_date = date('Y-m-d', strtotime($to_date));

    $to_date = date('Y-m-d', strtotime($to_date . ' +1 day'));

    if (isset($_POST['country']) && $_POST['country'] != '') {
        $country = $_POST['country'];
    }
}

$userListArray = array();

$orders = $wpdb->get_results("SELECT  p.ID,
        MAX(CASE WHEN pm.meta_key = '_billing_first_name' then pm.meta_value ELSE NULL END) as _billing_first_name,
        MAX(CASE WHEN pm.meta_key = '_billing_last_name' then pm.meta_value ELSE NULL END) as _billing_last_name,
        MAX(CASE WHEN pm.meta_key = '_billing_phone' then pm.meta_value ELSE NULL END) as _billing_phone,
        MAX(CASE WHEN pm.meta_key = '_billing_email' then pm.meta_value ELSE NULL END) as _billing_email,
        MAX(CASE WHEN pm.meta_key = '_completed_date' then pm.meta_value ELSE NULL END) as _completed_date,
        MAX(CASE WHEN pm.meta_key = '_customer_user' then pm.meta_value ELSE NULL END) as _customer_user,
        MAX(CASE WHEN pm.meta_key = '_order_total' then pm.meta_value ELSE NULL END) as _order_total,
        MAX(CASE WHEN pm.meta_key = '_billing_postcode' then pm.meta_value ELSE NULL END) as _billing_postcode,
        MAX(CASE WHEN pm.meta_key = '_billing_country' then pm.meta_value ELSE NULL END) as _billing_country

        FROM wp_posts p 
        LEFT JOIN wp_postmeta pm ON pm.post_id = p.ID
        WHERE p.post_type = 'shop_order' AND (p.post_status = 'wc-completed' or p.post_status = 'wc-processing') AND p.post_date BETWEEN '$from_date' and  '$to_date'
        GROUP BY p.ID");

foreach ($orders as $key => $val) {
    if ($country != '') {
        //if ($country == 'AU') {
            if ($val->_billing_country == $country) {
                $customer_name = strtolower(trim($val->_billing_first_name . ' ' . $val->_billing_last_name));
                if (empty(trim($val->_customer_user))) {
                    $userListArray[$customer_name]['total_order']++;
                    $userListArray[$customer_name]['amount'] = $userListArray[$customer_name]['amount'] + $val->_order_total;
                    $userListArray[$customer_name]['customer_name'] = ucwords($customer_name);
                    if (is_array($userListArray[$customer_name]) && !array_key_exists('first_order', $userListArray[$customer_name]))
                        $userListArray[$customer_name]['first_order'] = $val->_completed_date;
                    $userListArray[$customer_name]['last_order'] = $val->_completed_date;
                    $userListArray[$customer_name]['billing_email'] = $val->_billing_email;
                    $userListArray[$customer_name]['billing_phone'] = $val->_billing_phone;
                    $userListArray[$customer_name]['billing_postcode'] = $val->_billing_postcode;
                    $userListArray[$customer_name]['first_name'] = $val->_billing_first_name;
                    $userListArray[$customer_name]['last_name'] = $val->_billing_last_name;
                    $userListArray[$customer_name]['billing_country'] = $val->_billing_country;
                } else {
                    $userListArray[$val->_customer_user]['total_order']++;
                    $userListArray[$val->_customer_user]['amount'] = $userListArray[$val->_customer_user]['amount'] + $val->_order_total;
                    $userListArray[$val->_customer_user]['customer_name'] = ucwords($customer_name);
                    if (is_array($userListArray[$val->_customer_user]) && !array_key_exists('first_order', $userListArray[$val->_customer_user]))
                        $userListArray[$val->_customer_user]['first_order'] = $val->_completed_date;
                    $userListArray[$val->_customer_user]['last_order'] = $val->_completed_date;
                    $userListArray[$val->_customer_user]['billing_email'] = $val->_billing_email;
                    $userListArray[$val->_customer_user]['billing_phone'] = $val->_billing_phone;
                    $userListArray[$val->_customer_user]['billing_postcode'] = $val->_billing_postcode;
                    $userListArray[$val->_customer_user]['first_name'] = $val->_billing_first_name;
                    $userListArray[$val->_customer_user]['last_name'] = $val->_billing_last_name;
                    $userListArray[$val->_customer_user]['billing_country'] = $val->_billing_country;
                }
            }
        //}

       
    } else {
        $customer_name = strtolower(trim($val->_billing_first_name . ' ' . $val->_billing_last_name));
        if (empty(trim($val->_customer_user))) {
            $userListArray[$customer_name]['total_order']++;
            $userListArray[$customer_name]['amount'] = $userListArray[$customer_name]['amount'] + $val->_order_total;
            $userListArray[$customer_name]['customer_name'] = ucwords($customer_name);
            if (is_array($userListArray[$customer_name]) && !array_key_exists('first_order', $userListArray[$customer_name]))
                $userListArray[$customer_name]['first_order'] = $val->_completed_date;
            $userListArray[$customer_name]['last_order'] = $val->_completed_date;
            $userListArray[$customer_name]['billing_email'] = $val->_billing_email;
            $userListArray[$customer_name]['billing_phone'] = $val->_billing_phone;
            $userListArray[$customer_name]['billing_postcode'] = $val->_billing_postcode;
            $userListArray[$customer_name]['first_name'] = $val->_billing_first_name;
            $userListArray[$customer_name]['last_name'] = $val->_billing_last_name;
            $userListArray[$customer_name]['billing_country'] = $val->_billing_country;
        } else {
            $userListArray[$val->_customer_user]['total_order']++;
            $userListArray[$val->_customer_user]['amount'] = $userListArray[$val->_customer_user]['amount'] + $val->_order_total;
            $userListArray[$val->_customer_user]['customer_name'] = ucwords($customer_name);
            if (is_array($userListArray[$val->_customer_user]) && !array_key_exists('first_order', $userListArray[$val->_customer_user]))
                $userListArray[$val->_customer_user]['first_order'] = $val->_completed_date;
            $userListArray[$val->_customer_user]['last_order'] = $val->_completed_date;
            $userListArray[$val->_customer_user]['billing_email'] = $val->_billing_email;
            $userListArray[$val->_customer_user]['billing_phone'] = $val->_billing_phone;
            $userListArray[$val->_customer_user]['billing_postcode'] = $val->_billing_postcode;
            $userListArray[$val->_customer_user]['first_name'] = $val->_billing_first_name;
            $userListArray[$val->_customer_user]['last_name'] = $val->_billing_last_name;
            $userListArray[$val->_customer_user]['billing_country'] = $val->_billing_country;
        }
    }
}

$mydb = new wpdb('plus2_plus2', '7;-Ri[v^V}Cq', 'plus2_p2c_sep1live', '162.144.0.124');
$orders_full = $mydb->get_results("SELECT  p.ID,
        MAX(CASE WHEN pm.meta_key = '_billing_first_name' then pm.meta_value ELSE NULL END) as _billing_first_name,
        MAX(CASE WHEN pm.meta_key = '_billing_last_name' then pm.meta_value ELSE NULL END) as _billing_last_name,
        MAX(CASE WHEN pm.meta_key = '_billing_phone' then pm.meta_value ELSE NULL END) as _billing_phone,
        MAX(CASE WHEN pm.meta_key = '_billing_email' then pm.meta_value ELSE NULL END) as _billing_email,
        MAX(CASE WHEN pm.meta_key = '_completed_date' then pm.meta_value ELSE NULL END) as _completed_date,
        MAX(CASE WHEN pm.meta_key = '_customer_user' then pm.meta_value ELSE NULL END) as _customer_user,
        MAX(CASE WHEN pm.meta_key = '_order_total' then pm.meta_value ELSE NULL END) as _order_total,
        MAX(CASE WHEN pm.meta_key = '_billing_postcode' then pm.meta_value ELSE NULL END) as _billing_postcode,
        MAX(CASE WHEN pm.meta_key = '_billing_country' then pm.meta_value ELSE NULL END) as _billing_country

        FROM wp_posts p 
        LEFT JOIN wp_postmeta pm ON pm.post_id = p.ID
        WHERE p.post_type = 'shop_order' AND (p.post_status = 'wc-completed' or p.post_status = 'wc-processing') AND p.post_date BETWEEN '$from_date' and  '$to_date'
        GROUP BY p.ID");

foreach ($orders_full as $key => $val) {
    if ($country != '') {
        if ($country == 'AU') {
            if ($val->_billing_country == $country) {
                $customer_name = strtolower(trim($val->_billing_first_name . ' ' . $val->_billing_last_name));
                if (empty(trim($val->_customer_user))) {
                    $userListArray[$customer_name]['total_order']++;
                    $userListArray[$customer_name]['amount'] = $userListArray[$customer_name]['amount'] + $val->_order_total;
                    $userListArray[$customer_name]['customer_name'] = ucwords($customer_name);
                    if (is_array($userListArray[$customer_name]) && !array_key_exists('first_order', $userListArray[$customer_name]))
                        $userListArray[$customer_name]['first_order'] = $val->_completed_date;
                    $userListArray[$customer_name]['last_order'] = $val->_completed_date;
                    $userListArray[$customer_name]['billing_email'] = $val->_billing_email;
                    $userListArray[$customer_name]['billing_phone'] = $val->_billing_phone;
                    $userListArray[$customer_name]['billing_postcode'] = $val->_billing_postcode;
                    $userListArray[$customer_name]['first_name'] = $val->_billing_first_name;
                    $userListArray[$customer_name]['last_name'] = $val->_billing_last_name;
                    $userListArray[$customer_name]['billing_country'] = $val->_billing_country;
                } else {
                    $userListArray[$val->_customer_user]['total_order']++;
                    $userListArray[$val->_customer_user]['amount'] = $userListArray[$val->_customer_user]['amount'] + $val->_order_total;
                    $userListArray[$val->_customer_user]['customer_name'] = ucwords($customer_name);
                    if (is_array($userListArray[$val->_customer_user]) && !array_key_exists('first_order', $userListArray[$val->_customer_user]))
                        $userListArray[$val->_customer_user]['first_order'] = $val->_completed_date;
                    $userListArray[$val->_customer_user]['last_order'] = $val->_completed_date;
                    $userListArray[$val->_customer_user]['billing_email'] = $val->_billing_email;
                    $userListArray[$val->_customer_user]['billing_phone'] = $val->_billing_phone;
                    $userListArray[$val->_customer_user]['billing_postcode'] = $val->_billing_postcode;
                    $userListArray[$val->_customer_user]['first_name'] = $val->_billing_first_name;
                    $userListArray[$val->_customer_user]['last_name'] = $val->_billing_last_name;
                    $userListArray[$val->_customer_user]['billing_country'] = $val->_billing_country;
                }
            }
        }

        if ($country == 'all') {
            if ($val->_billing_country != 'AU') {
                $customer_name = strtolower(trim($val->_billing_first_name . ' ' . $val->_billing_last_name));
                if (empty(trim($val->_customer_user))) {
                    $userListArray[$customer_name]['total_order']++;
                    $userListArray[$customer_name]['amount'] = $userListArray[$customer_name]['amount'] + $val->_order_total;
                    $userListArray[$customer_name]['customer_name'] = ucwords($customer_name);
                    if (is_array($userListArray[$customer_name]) && !array_key_exists('first_order', $userListArray[$customer_name]))
                        $userListArray[$customer_name]['first_order'] = $val->_completed_date;
                    $userListArray[$customer_name]['last_order'] = $val->_completed_date;
                    $userListArray[$customer_name]['billing_email'] = $val->_billing_email;
                    $userListArray[$customer_name]['billing_phone'] = $val->_billing_phone;
                    $userListArray[$customer_name]['billing_postcode'] = $val->_billing_postcode;
                    $userListArray[$customer_name]['first_name'] = $val->_billing_first_name;
                    $userListArray[$customer_name]['last_name'] = $val->_billing_last_name;
                    $userListArray[$customer_name]['billing_country'] = $val->_billing_country;
                } else {
                    $userListArray[$val->_customer_user]['total_order']++;
                    $userListArray[$val->_customer_user]['amount'] = $userListArray[$val->_customer_user]['amount'] + $val->_order_total;
                    $userListArray[$val->_customer_user]['customer_name'] = ucwords($customer_name);
                    if (is_array($userListArray[$val->_customer_user]) && !array_key_exists('first_order', $userListArray[$val->_customer_user]))
                        $userListArray[$val->_customer_user]['first_order'] = $val->_completed_date;
                    $userListArray[$val->_customer_user]['last_order'] = $val->_completed_date;
                    $userListArray[$val->_customer_user]['billing_email'] = $val->_billing_email;
                    $userListArray[$val->_customer_user]['billing_phone'] = $val->_billing_phone;
                    $userListArray[$val->_customer_user]['billing_postcode'] = $val->_billing_postcode;
                    $userListArray[$val->_customer_user]['first_name'] = $val->_billing_first_name;
                    $userListArray[$val->_customer_user]['last_name'] = $val->_billing_last_name;
                    $userListArray[$val->_customer_user]['billing_country'] = $val->_billing_country;
                }
            }
        }
    } else {
        $customer_name = strtolower(trim($val->_billing_first_name . ' ' . $val->_billing_last_name));
        if (empty(trim($val->_customer_user))) {
            $userListArray[$customer_name]['total_order']++;
            $userListArray[$customer_name]['amount'] = $userListArray[$customer_name]['amount'] + $val->_order_total;
            $userListArray[$customer_name]['customer_name'] = ucwords($customer_name);
            if (is_array($userListArray[$customer_name]) && !array_key_exists('first_order', $userListArray[$customer_name]))
                $userListArray[$customer_name]['first_order'] = $val->_completed_date;
            $userListArray[$customer_name]['last_order'] = $val->_completed_date;
            $userListArray[$customer_name]['billing_email'] = $val->_billing_email;
            $userListArray[$customer_name]['billing_phone'] = $val->_billing_phone;
            $userListArray[$customer_name]['billing_postcode'] = $val->_billing_postcode;
            $userListArray[$customer_name]['first_name'] = $val->_billing_first_name;
            $userListArray[$customer_name]['last_name'] = $val->_billing_last_name;
            $userListArray[$customer_name]['billing_country'] = $val->_billing_country;
        } else {
            $userListArray[$val->_customer_user]['total_order']++;
            $userListArray[$val->_customer_user]['amount'] = $userListArray[$val->_customer_user]['amount'] + $val->_order_total;
            $userListArray[$val->_customer_user]['customer_name'] = ucwords($customer_name);
            if (is_array($userListArray[$val->_customer_user]) && !array_key_exists('first_order', $userListArray[$val->_customer_user]))
                $userListArray[$val->_customer_user]['first_order'] = $val->_completed_date;
            $userListArray[$val->_customer_user]['last_order'] = $val->_completed_date;
            $userListArray[$val->_customer_user]['billing_email'] = $val->_billing_email;
            $userListArray[$val->_customer_user]['billing_phone'] = $val->_billing_phone;
            $userListArray[$val->_customer_user]['billing_postcode'] = $val->_billing_postcode;
            $userListArray[$val->_customer_user]['first_name'] = $val->_billing_first_name;
            $userListArray[$val->_customer_user]['last_name'] = $val->_billing_last_name;
            $userListArray[$val->_customer_user]['billing_country'] = $val->_billing_country;
        }
    }
}

//getting average of every user purchase
$total_orders = $total_customer = $total_amount = $average = $repeatedUser = $repeatUserPecentage = 0;
$less_than_80 = $less_than_20 = $orders_not_from_australia = 0;

foreach ($userListArray as $key => $value) {
    $userListArray[$key]['average_purchase'] = number_format(floatval($value['amount']) / intval($value['total_order']), 2);
}

foreach ($userListArray as $key => $val) {

//    if (intval($val["amount"]) < 21) {
//        $less_than_20++;
//        unset($userListArray[$key]);
//    }

    if ($val["billing_country"] != 'AU') {
        $total_customer++;
        $total_orders += intval($val['total_order']);
        $orders_not_from_australia += floatval($val['amount']);
    } else {
        $total_customer++;
        $total_orders += intval($val['total_order']);
        $total_amount += floatval($val['amount']);
    }
}

foreach ($userListArray as $key => $value) {
   // if (intval($value["total_order"]) > 1 && is_numeric($key))
		 if (is_numeric($key))
        $repeatedUser++;
}

foreach ($userListArray as $key => $value) {
    if (intval($value["total_order"]) > 1 && is_numeric($key))
		// if (is_numeric($key))
        $repeatedUser1++;
}


$average = number_format(floatval($total_amount / $total_customer), 2);
$total_amount = number_format(floatval($total_amount), 2);
$repeatUserPecentage = number_format(floatval((intval($repeatedUser) / $total_customer) * 100), 2);
$repeatUserPecentage1 = number_format(floatval((intval($repeatedUser1) / count($userListArray)) * 100), 2);

$final_json_data = json_encode(array('userListArray' => $userListArray, 'total_customer' => $total_customer, 'total_orders' => $total_orders, 'total_amount' => $total_amount, 'average' => $average, 'repeatedUser' => $repeatedUser, 'repeatedUser1' => $repeatedUser1,'repeatUserPecentage' => $repeatUserPecentage,'repeatUserPecentage1' => $repeatUserPecentage1));

$final_results = json_decode($final_json_data);

// echo '<pre>'; print_r($final_results); die;


/*$from_date = date('Y-01-01');
$to_date = date('Y-m-d');
if(isset($_POST["from_date"]) && !empty(trim($_POST["from_date"])))
	$from_date = date('Y-m-d',strtotime(trim($_POST["from_date"])));
if(isset($_POST["to_date"]) && !empty(trim($_POST["to_date"])))
	$to_date = date('Y-m-d',strtotime(trim($_POST["to_date"])));*/

?>

<style>
    /*#average-order-table.table thead tr th:nth-child(4),
    #average-order-table.table tbody tr td:nth-child(4) { display:none; }	*/
    .page-template-test_orders #ui-datepicker-div {
        z-index: 111 !important;
    }

    .page-template-test_orders #average-order-table {
        width: 100% !important;
        overflow-x: scroll;
        display: block;
    }
</style>

<!-- <link type="text/css" rel="stylesheet" href="<?php echo get_template_directory_uri() . '/assets/css/jquery-ui.css'; ?>" /> -->
<!-- <link type="text/css" rel="stylesheet" href="<?php echo get_template_directory_uri() . '/assets/css/jquery.dataTables.min.css'; ?>" /> -->
<link type="text/css" rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.2/css/buttons.dataTables.min.css"/>


<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet"
      type="text/css"/>

<div id="average-order" class="row category-page">

    <div class="title-barc"><h1>Users Orders (Average)</h1></div>

    <div class="large-3 hide-for-small columns left">
        <div class="">
            <form method="post">
                <div>
                    <label>From</label>
                    <input type="text" autocomplete="off" placeholder="From Date"
                           value="<?php echo date('m/d/Y', strtotime($from_date)); ?>" id="from_date" name="from_date"
                           readonly required/>
                </div>
                <div>
                    <label>To</label>
                    <input type="text" autocomplete="off" placeholder="To Date" id="to_date"
                           value="<?php echo date('m/d/Y', strtotime($to_date_original)); ?>" name="to_date" readonly required/>
                </div>
                <div> 
                    <label>Filter by Country</label>
                    <!-- <input type="text" autocomplete="off" placeholder="To Date" id="to_date" value="<?php echo date('m/d/Y', strtotime($to_date)); ?>" name="to_date" readonly required/> -->
                    <?php $countries = $wpdb->get_results("SELECT DISTINCT meta_value FROM wp_postmeta WHERE  meta_key = '_billing_country'");
                    ?>
                    <select id="country_filter" name="country" class="select_country">
                        <!-- <option value="">Select an option</option> -->
                        <option <?php if ($country == '') echo 'selected'; ?> value="">Select an option</option>
                        <?php foreach($countries as $country) {
                            if (ctype_alpha($country->meta_value)) { ?>
                                <option <?php if ($country == $country->meta_value) echo 'selected'; ?> value="<?php echo $country->meta_value; ?>"><?php echo $country->meta_value; ?></option>
                            <?php }
                        }?>
                        
                    </select>
                </div>
                <input type="submit" class="button small" value="Filter Result"/>
            </form>
        </div>
        <!--<a href="javascript:downloadCSV()" class="button alt-button primary small">Download CSV</a>-->
    </div>

    <!--Html to display non-australian order in table view-->
    <div class="large-9 right columns" id="no_aus_data">
        <div class="average-info">
            <table>
                <tbody>
                <tr>
                    <th>Total Customers</th>
                    <td><?php echo $total_customer; ?></td>
                </tr>
                <tr>
                    <th>Total Orders</th>
                    <td><?php echo $total_orders; ?></td>
                </tr>
                <tr>
                    <th>Orders not from australia</th>
                    <td>$<?php echo $orders_not_from_australia; ?></td>
                </tr>
                <tr>
                    <th>Total Orders Amount</th>
                    <td>$<?php echo $total_amount; ?></td>
                </tr>
                <tr>
                    <th>Average</th>
                    <td>$<?php echo $average; ?><sub>&emsp;(Total Orders Amount/Total Customers)</sub></td>
                </tr>
                <tr>
                    <th>Returning Customer</th>
                    <td><?php echo $repeatUserPecentage . '%'; ?>
                        <sub>(<?php echo $repeatedUser . ' of ' . $total_customer; ?>)</sub></td>
                </tr>
				
				<!-- <tr>
                    <th>Repeat Buyers</th>
                    <td><?php // echo $repeatUserPecentage1 . '%'; ?>
                        <sub>(<?php  //echo $repeatedUser1 . ' of ' . $total_customer; ?>)</sub></td>
                </tr> -->
				
                </tbody>
        </div>
        <table id="average-order-table" class="display nowrap table" style="width:100% !important">
            <thead>
            <tr>
                <th>S. No.</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Phone Number</th>
                <th>Email</th>
                <th>Total Order</th>
                <th>Total Amount</th>
                <th>Average Purchase</th>
		<th>Country Code</th>
                <th style="display:none;">PostCode</th>
                <th>First Order <br/><sub>(yyyy-mm-dd)</sub></th>
                <th>Last Order Date <br/><sub>(yyyy-mm-dd)</sub></th>
            </tr>
            </thead>
            <body>
            <?php
            if (isset($final_results->userListArray) && count($final_results->userListArray)) {
            $sno = 1;

            foreach ($final_results->userListArray as $key => $val) { ?>
                    <tr>
                        <td><?php echo $sno;  ?></td>
                        <td><?php echo ucwords($val->first_name);  ?></td>
                        <td><?php echo ucwords($val->last_name);  ?></td>
                        <td><?php echo ucwords($val->billing_phone);  ?></td>
                        <td><?php echo ucwords(trim($val->billing_email))  ?></td>
                        <td><?php echo ucwords(trim($val->total_order))  ?></td>
                        <td>$ <?php echo ucwords(trim($val->amount))  ?></td>
                        <td>$ <?php echo ucwords(trim($val->average_purchase))  ?></td>
			<td><?php echo ucwords(trim($val->billing_country))  ?></td>
                        <td style="display:none;"><?php echo ucwords(trim($val->billing_postcode))  ?></td>
                        <td><?php echo ucwords(trim($val->first_order))  ?></td>
                        <td><?php echo ucwords(trim($val->last_order))  ?></td>
                    </tr>
                    <?php $sno++;
                } ?>
            <?php } else { ?>
                <tr>
                    <td colspan="6">No Record Found!</td>
                </tr>
            <?php }
            ?>
            </body>
        </table>
        <br/><br/><br/>
    </div>
</div>
<style>
.title-barc {
    display: none;
}
</style>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>

<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css"/>
<!-- <script src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script> -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.flash.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.print.min.js"></script>

<script>
    jQuery(document).ready(function () {
        jQuery('#from_date, #to_date').datepicker({
            dateFormat: 'dd-mm-yy',
        });

        /*jQuery('#average-order-table').DataTable({
            dom: 'Bfrtip',
            buttons: [
                'csvHtml5', 'excelHtml5'
            ]
        });*/

        jQuery('#average-order-table').DataTable({
            "pageLength": 15,
            dom: 'Bfrtip',
            buttons: [
                {
                    text: 'CSV',
                    action: function (e, dt, node, config) {
                        //alert( 'Button activated' );
                        var password = window.prompt("Enter Password", "Password");
                        //alert(password);

                        if (password == 'prestige$34') {
                            //'csv'
                            //alert('matched');
                            jQuery('.buttons-csv').click();
                        }
                        else {
                            alert("Incorrect Password");
                        }
                    }
                },
                'csv',
                {
                    text: 'EXCEL',
                    action: function (e, dt, node, config) {
                        //alert( 'Button activated' );
                        var password = window.prompt("Enter Password", "Password");
                        //alert(password);

                        if (password == 'prestige$34') {
                            //'csv'
                            //alert('matched');
                            jQuery('.buttons-excel').click();
                        }
                        else {
                            alert("Incorrect Password");
                        }
                    }
                },
                'excel',

            ]
        });
        jQuery(".buttons-csv").hide();
        //jQuery(".buttons-csv").off("click");
        jQuery(".buttons-excel").hide();
        //jQuery(".buttons-excel").off("click");

    });
</script>

<?php get_footer(); ?>
